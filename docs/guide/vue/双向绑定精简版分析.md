# 双向绑定精简版（版本：3.2）——track trigger effect

Vue3 中双向绑定的核心函数为：

-   track
-   trigger
-   effect

还有 targetMap，这是一个 WeakMap 类型的依赖缓存。

```js
const targetMap = {
    target: {
        key: new Set([effect]),
    },
};
```

这里用对象来表示大概的数据结构。

targetMap 为 key 为目标对象，value 为 depsMap 的 WeakMap

depsMap 为 key 为目标对象的具体需要获取的 key，value 为 dep 的 Map

dep 为 一个 Set 数据结构，值为 副作用函数（effect）。

我们可以用这三个函数实现一个响应式

```js
setup() {
      const state = {
        msg: 'Hello World',
        showMsg: true
      }

      effect(() => {
        console.log(state.msg) // Hello Vue3
        track(state, 'get', 'msg')
      })

      setTimeout(() => {
        debugger
        state.msg = 'Hello Vue3'

        trigger(state, 'set', 'msg', 'Hello Vue')
      }, 1000)

      return {}
    }
```

track 函数接收三个参数，目标对象，track 操作类型，对象 key。

-   target: 要追踪的对象
-   type: 操作类型 (get | has | iterate)
-   key: 要跟踪对象对应的 key

trigger 函数接收六个参数，目标对象，trigger 操作类型，对象 key，新值，老值，用于调试

-   target: 要追踪的对象
-   type: 操作类型 (set | add | delete | clear)
-   key: 要跟踪对象对应的 key
-   newValue: 对应 set 操作的新值
-   oldValue: 未操作前的旧值
-   oldTarget: 用于调试

effect 函数用于定义副作用函数。配和 targetMap 定义了一个数据结构。

```js
// 伪代码
targetMap: {
    target: depsMap
}

depsMap: {
    key: dep
}

dep: [effect1, effect2, ...]

// targetMap: 类型为 WeakMap
// depsMap: 类型为 Map
// dep: 类型为 Set

```

所以响应式的流程其实是 effect 函数定义副作用函数，track 函数跟踪依赖，trigger 函数触发副作用函数。
